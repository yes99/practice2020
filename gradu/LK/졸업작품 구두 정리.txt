우선 비디오 파일을 불러온다. 
비디오를 불러 오면서 글로벌로 프레임 번호를 선언해주고
프레임수와 관련한 작업을 해줘서 키보드 이벤트가 쉽게 작용할수 잇게 해준다. 

비디오 파일을 불러온다. 

첫번째 프레임이거나, 스페이스를 누르면 
윈도우가 새롭게 뜨면서 네모를 그릴수 있는 새로운 창을 만든다. 
이 상태에서 r을 누르면 윈도우를 새롭게 띄워서 네모를 다시 그릴수 있고
s를 누르면 해당 네모 부위를 잘라서 쿼리라는 jpg 파일로 저장을 한다.

그리고 Optical_flow 함수를 작동 시킨다. 

옵티컬플로우 함수를 작동한다. 
우선 첫번째 프레임일 경우에는, 그냥 프레임을 그대로 리턴 하고
이미지1은 쿼리를 읽어오고 그레이 처리 하고
이미지2는 해당 프레임을 가져오고 처리 하도록 한다.

코너를 검출해야하는데
prePt에서 코너검출을 한다. 이전 프레임에서 어떤 부분에 코너가 검출되는지 확인할수 있다. 
https://darkpgmr.tistory.com/131
코너를 검출함에 있어서, 아이젠 밸류가 작은 것만 고려해서 빠르게 계산하는 것이다. 

nextPt , status,  err을 calcOpticalFlowPyrLK 함수에 넣어준다.
calcOpticalFlowPyrLK  함수에는, 그레이화 시킨 이전이미지, 현재 이미지, 그리고 구한 2디점 벡터들, 상태 등을 전해준다.

이 함수는 이전 프레임에서 추적할 포인트가 연속된 다음 프레임에서 추적될 경우 상태값 1을 반환하고 발견되지 못할 경우 0을 반환합니다. 또한 추적할 포인트가 이동한 새로운 위치값도 함께 반환합니다. 다음 예제를 통해 더 깊이 이해할 수 있습니다
그래서 status가 1이 된것들만 한번 거른다고 한 것이다. 

- 네모의 이동 알고리즘
한 프레임 전체를 쭉 돌면서 움직인 방향을 전체적으로 탐색할 것이다. 
프레임 전체에서 움직인 점들 중, 우리가 친 네모 안에 들어있는 점을 찾고
x y좌표로 얼마나 이동했는지 각각 누적값을 구하고 그 점의 갯수를 구한다. 
이를 반올림해서 나누면 네모가 전체적으로 이동해야할 거리가 나온다. 


- 네모의 크기 알고리즘
10번째 프레임부터 사이즈를 적용하도록 한다. 
우선, 사이즈를 조정하는 기본적인 원리는 네모가 커질수록 안에 잡히는 코너들의 갯수 차이에 따라서 할것이다. 

따라허 diff 는 현재 코너갯수 - 이전 코너 갯수 이다. 

diff가 -6보다 더 작을 경우에는, 로고가 작아진다.  현재 특징점이 더 적기 때문이다. 
diff가 6보다 클 경우에는, 로고가 반대의 이유로 커지는 것이다. +


- 인페인팅 과정

네모친 부분을 잘라서 원본으로 저장한다. 
자른 이미지를 그레이 스케일로 바꿔주고
이것을 복사해서, 이진화를 시켜준다. 
인페인팅 연산을 하고 

이 알고리즘은 먼저 이 영역의 경계로부터 시작하며 영역 내부를 영역의 외곽선부터 시작해 점진적으로 채웁니다. 복원될 곳의 픽셀 주위의 이웃(인근)에 작은 범위의 픽셀을 구합니다. 구해진 픽셀들의 정규화된 가중치 합으로 계산되어진 값으로 복원될 픽셀이 교체됩니다. 가중치 값의 선택은 매우 중요한 문제입니다. 복원 지점에 가깝게 놓여져 있을수록 더 많은 가중치값이 주어집니다. 일단 하나의 픽셀이 복원되면, Fast Matching Method를 사용해 가장 가까운 다음 픽셀로 이동합니다. 이 알고리즘은 cv2.INPAINT_TELEA 플래그를 사용해 활성화됩니다.

가우시안 블러링을 살짝 해주고 해당 이미지를 리턴해준다. 






이정도가 일단 우리 돌아감

우리가 핵심으로 쓰는 내장 함수를 좀 설명해야하는데 
우리가 핵심으로 쓰는 내장 함수는
goodFeaturesToTrack
calcOpticalFlowPyrLK 
inpaint 

이렇게 세개가 우리가 쓰는 핵심 함수임 inpaint만 설명하기 조금 애매함, 찾아 보겠담


_______________여기서 부터는 내 생각 겸 앞으로 개선해야 할점___________________

실제 영상 돌릴게 생각 보다 별로 없음.  우리가 브이로그 찍는 척을 해야하나. 직캠으로 좀 돌려봤는데 너무 역동적이어서 이걸 예시로 보여드리긴 좀 그래 ㅋㅋㅋㅋ
교수님이 보내준거 처럼 다각형으로 하면 좋을텐데 우리에게는 네모가 한계....
이진화 파트 말인데, 저거 약간 한계가 있는거가, 옷 자체가 밝으면 이진화 제대로 안됨 ㅋㅋㅋ 예시 보여드림. 

- 개선 해야 할점
개선이라기 보다는, 그냥 장치적으로 좀 바꿔줬으면 하는거가
씬체인지를 이제 비슷하게라도 넣어볼까 생각 중임, 왜냐하면 평범한 영상에서 재생을 하려면 씬이 확 바뀔때 이게 divide by zero가 뜨면서 터져버림, 씬체인지 안넣더라도, 한번 터질 경우에 다시 이어갈수 있게 추가좀 해야할거 같음. 
이거 특정버튼 누르면 영상 그냥 재생되도록 바꿔보자

이따가 내가 예시 몇개 돌려본거 보여드릴게
